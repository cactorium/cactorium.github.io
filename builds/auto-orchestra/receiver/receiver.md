# Receiver Build
This is the most complicated PCB I've designed so far.
This picks up the light from the transmitter, amplifies the voltage up to a usable level, passes it through an ADC, and then transferred into the host computer via USB.
The signal path is transimpedance (TIA) amplifier, a fixed gain amplifier stage, two variable-gain amplifier stages, then the ADC, the STM32F07 MCU, and finally the USB connection.

## Design
I spent a lot of time researching the design for the transimpedance amplifier.
Even with all that work, I was expecting an SNR of around 7-ish at the output here, which is not ideal but still plenty for decoding.
A transimpedance amplifier converts a current into a voltage, in this case converting the current generated by the photodiode into voltage.
The amount of noise generated in this stage is absolutely crucial to performance, so I spent a lot of time analyzing this stage and comparing amplifiers to try to minimize the noise of this stage.
Based on a lot of reading, it seems like the ideal strategy was to have as high of feedback resistor value as you could, while still ensuring the amplifier was stable and you still had enough bandwidth for your design requirements.
This worked because the signal would be boosted linearly, while the noise generated as a result of increasing the feedback resistance would only rise by the square root of the resistance.
This meant you'd increase the SNR (assuming the Johnson noise of the feedback resistor was the dominant contributor of noise) with any increase of the feedback resistance.

I designed this stage with several optional sections.
I added some BJTs to cancel out the DC component of the signal; Q203 and Q204 act as a current mirror with an RC circuit in the middle of it.
They'd conduct any low frequency components of the signal instead of having it pass through the 1 M feedback resistor that it's intended to.
Any high frequency components would be absorbed by the RC filter at the BJT's emitter, preventing the current mirror from copying any high frequency currents.
Thus, low frequency components would be bypassed while high frequency components lead to voltage being generated across the feedback resistor and consequently across the output.

I was also experimented with adding a bootstrap JFET.
This would fix the voltage across the photodiode, effectively nulling its high parasitic capacitance and boosting the TIA's bandwidth.
For both of these stages, my biggest concern was with whether the benefits they provided offset the increased noise I'd see in the circuit.
To test all of these out, I planned on assembling several boards and testing out different variations to see which performed best.

TODO maybe take a picture of the noise analysis stuff if I can find it

Then there's a pretty simple 50x fixed gain amplifier stage, which is a pretty standard inverting op amp topology using the second half of the MAX4477AUA.
The resistor values around here are pretty low to avoid adding too much Johnson noise, since any noise added here would be amplified along with the signal through the rest of the chain.
Also, basically every amplifier stage has a capacitor at its input to both mitigate the effect of offset voltage and to filter out low frequency noise and an RC filter at its output to filter out high frequency noise, plus some feedback capacitance to ensure good stability and attenuate high frequency noise even further.
This basically meant the chain acted as a lazily designed bandpass filter.

TODO talk about variable gain stages

The digital circuitry was fed using a single 3.3 V LDO powered off the input +5 V rail.
The analog circuitry was powered off of two boost converters, generating +12 V and -12 V from +5 V, which were then used to generate all the analog voltages.
These two converters were selected for high frequency, so that they, and any intermodulation components that might be generated, were very far from the 10 kHz I was expecting from the transmitter.
I was really worried about noise, so I made my own discrete linear regulators to drop the +12 V rail down to +5 V and +10 V.
These both shared a ADR550 shunt precision voltage reference, using a pair of op amps and a pair of BJTs to enhance the current capability of the op amps in a simple, standard configuration.
To reduce noise even further, basically everything has a 33 ohm resistor slapped between their bypass capacitors and the power supply to attenuate any noise on the power rails.

## Results
It works! At least up to the ADC input right now

TODO fill in

## Mistakes
So far I've found a bunch of them!
Let's go through it section by section

### Power supplies
This probably caused the most trouble.
First off, I has the footprint for one of the converters backwards, which took a fair bit of testing and a couple sacrificial ICs to work out.
Luckily the package was designed so that the pins almost touch the top surface of the IC, and there wasn't a ground pad, so it was pretty easy just to flip the chip over and solder it that way.

The

### Transimpedance amplifier
Not much actually failed here.
I ended up not using any of the complicated DC-blocking or bootstrapping circuitry, since the amplifier didn't seem to saturate under the nighttime conditions I was planning on using it on.
Soo that's a lot of design work down the drain, I guess that's what I get for doing almost no experimenting before starting the design.

### Amplifiers
Not much broke in these stages, although there was some noise I haven't tracked down yet on the output of the first variable gain stage.
The control circuitry works, but I'm not entirely sure theory wise why it works.
As mentioned before, 

TODO talk about JFET gate oscillations
