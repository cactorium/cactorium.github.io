# Receiver Build
This is the most complicated PCB I've designed so far.
This picks up the light from the transmitter, amplifies the voltage up to a usable level, passes it through an ADC, and then transferred into the host computer via USB.
The signal path is transimpedance (TIA) amplifier, a fixed gain amplifier stage, two variable-gain amplifier stages, then the ADC, the STM32F07 MCU, and finally the USB connection.

## Design
I spent a lot of time researching the design for the transimpedance amplifier.
Even with all that work, I was expecting an SNR of around 7-ish at the output here, which is not ideal but still plenty for decoding.
A transimpedance amplifier converts a current into a voltage, in this case converting the current generated by the photodiode into voltage.
The amount of noise generated in this stage is absolutely crucial to performance, so I spent a lot of time analyzing this stage and comparing amplifiers to try to minimize the noise of this stage.
Based on a lot of reading, it seems like the ideal strategy was to have as high of feedback resistor value as you could, while still ensuring the amplifier was stable and you still had enough bandwidth for your design requirements.
This worked because the signal would be boosted linearly, while the noise generated as a result of increasing the feedback resistance would only rise by the square root of the resistance.
This meant you'd increase the SNR (assuming the Johnson noise of the feedback resistor was the dominant contributor of noise) with any increase of the feedback resistance.

I designed this stage with several optional sections.
I added some BJTs to cancel out the DC component of the signal; Q203 and Q204 act as a current mirror with an RC circuit in the middle of it.
They'd conduct any low frequency components of the signal instead of having it pass through the 1 M feedback resistor that it's intended to.
Any high frequency components would be absorbed by the RC filter at the BJT's emitter, preventing the current mirror from copying any high frequency currents.
Thus, low frequency components would be bypassed while high frequency components lead to voltage being generated across the feedback resistor and consequently across the output.

I was also experimented with adding a bootstrap JFET.
This would fix the voltage across the photodiode, effectively nulling its high parasitic capacitance and boosting the TIA's bandwidth.
For both of these stages, my biggest concern was with whether the benefits they provided offset the increased noise I'd see in the circuit.
To test all of these out, I planned on assembling several boards and testing out different variations to see which performed best.

TODO maybe take a picture of the noise analysis stuff if I can find it

Then there's a pretty simple 50x fixed gain amplifier stage, which is a pretty standard inverting op amp topology using the second half of the MAX4477AUA.
The resistor values around here are pretty low to avoid adding too much Johnson noise, since any noise added here would be amplified along with the signal through the rest of the chain.
Also, basically every amplifier stage has a capacitor at its input to both mitigate the effect of offset voltage and to filter out low frequency noise and an RC filter at its output to filter out high frequency noise, plus some feedback capacitance to ensure good stability and attenuate high frequency noise even further.
This basically meant the chain acted as a lazily designed bandpass filter.

There's two variable gain stages, the first of which uses a JFET as a voltage-controlled resistor.
The JFET's gate bias is controlled using an op amp, which servos the voltage it's fed into a controlled current, which then leads to a controlled voltage drop from the reference node on the op amp to the JFET's gate.
The voltage fed into the op amp is controlled by an Attiny412, which generates a PDM signal that's fed into two stages of low pass filtering before reaching the op amp input.
The second variable gain stage uses an analog switch to switch between two resistors, allowing either 2x or 33x gain.

TODO ADC, MCU

The digital circuitry was fed using a single 3.3 V LDO powered off the input +5 V rail.
The analog circuitry was powered off of two boost converters, generating +12 V and -12 V from +5 V, which were then used to generate all the analog voltages.
These two converters were selected for high frequency, so that they, and any intermodulation components that might be generated, were very far from the 10 kHz I was expecting from the transmitter.
I was really worried about noise, so I made my own discrete linear regulators to drop the +12 V rail down to +5 V and +10 V.
These both shared a ADR550 shunt precision voltage reference, using a pair of op amps and a pair of BJTs to enhance the current capability of the op amps in a simple, standard configuration.
To reduce noise even further, basically everything has a 33 ohm resistor slapped between their bypass capacitors and the power supply to attenuate any noise on the power rails.

## Results
It works!
It's generating data at ~100 kHz, although that might be scaled down if that ends up being too high for the Raspberry Pi 3 (the target platform) to process.

TODO fill in after everything's working

## Mistakes
So far I've found a bunch of them!
Let's go through it section by section

### Power supplies
This probably caused the most trouble.
First off, I has the footprint for one of the converters backwards, which took a fair bit of testing and a couple sacrificial ICs to work out.
Luckily the package was designed so that the pins almost touch the top surface of the IC, and there wasn't a ground pad, so it was pretty easy just to flip the chip over and solder it that way.

There's noticeable noise in the >1 MHz range basically everywhere in the circuit, because of the switching regulators that power everything.
Even with the RC filters, there's still measurable noise in the reference circuitry, which then gets mirrored on all the supplies and consequently into the signal circuitry.
In fact, the RC filters don't seem to attenuate it much at all.
It actually doesn't seem like a big deal (which is why I chose high frequency switchers in the first place) since this is well outside of the target frequency range, but it does bother me a bit.

### Transimpedance amplifier
Not much actually failed here.
I ended up not using any of the complicated DC-blocking or bootstrapping circuitry, since the amplifier didn't seem to saturate under the nighttime conditions I was planning on using it on.
Soo that's a lot of design work down the drain, I guess that's what I get for doing almost no experimenting before starting the design.

### Amplifiers
Not much broke in these stages, although there was some noise I haven't tracked down yet on the output of the first variable gain stage.
The control circuitry works, but I'm not entirely sure theory wise why it works.
As I mentioned before, it's got two stages of RC filters into the op amp, which uses a BJT with a current sensing resistor to control the current passing into another resistor, which sets the voltage bias on the JFET's gate.
The voltage across the current sensing resistor is fed back to both the op amp for feedback as well as into a Attiny412, also as feedback.
The Attiny uses its free running ADC to sample the voltage at around 48 kHz, runs a PI controller and outputs a PDM signal, which is fed into the RC filters into the amplifier input.
I figured that, since the cascaded RC filters would lead to high phase shift to close to 180 degrees at higher frequencies, it'd make sense to have a dominant integrating term to simultaneously null out the effect of op amp input offset and compensate for some of the input phase lag.
I simulated this and it seems to work correctly, but when I tested it in real life it ended up with some strong oscillations in the ~40 Hz range.
I added a lot of dampening (~500x) in the form of the proportional term, and that seems to have stabilized it, although multimeter measurements seem to indicate that there's still some weird stuff going on.

Also, I could've designed the switching for the second gain stage better.
As of right now, switching between the two leads to a temporary break in the feedback loop, which probably leads to some short lived transients in the output signal.
More importantly, the clamping circuitry after it is not well designed at all.
It should really be a bunch of diodes hooked up in parallel with the feedback loop, which wouldn't lead to the op amp overdriving.

I didn't look very closely at the original op amp that set the JFET bias, so the common mode input range of the one I chose didn't actually go down to ground.
This meant that I couldn't reduce the bias of the JFET down to zero, it got stuck at around 0.9 V.
Luckily this was in a common package so it was just a matter of swapping out the part for a pin compatible one.
There were a lot of cheap op amps that had the right CMR, but lacked the ability to drive the output close enough to the rails for what I needed, which I could have accounted for at the beginning if I'd known about it by moving the positive voltage rail up to 15 V.
The issue is that this was a quad op amp package, and one of the op amps was used to regulate the 10 V rail.
Most op amps seem to be spec'd to work up to Vcc-2 V, which means they wouldn't be able to drive the voltage high enough to get 10 V at the BJT's emitter/output.
So I ended up getting a much more expensive (almost 10x!) op amp, with okayish noise.

### ADC

TODO talk about how I fucked up the ADC input design
